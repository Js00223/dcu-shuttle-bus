import re
from database import SessionLocal, engine
import models
from sqlalchemy import text

# 데이터베이스 테이블 생성
models.Base.metadata.create_all(bind=engine)

# 사용자가 제공한 전체 데이터 리스트
shuttle_data_raw = [
    "1호차 등교(계명대학교)", "1호차 하교(동천지구대)", "2호차 등교(서구청)", 
    "2호차 하교(홈플러스 칠곡점)", "3호차 등교(동서영남아파트)", "3호차 하교(서부정류장역)", 
    "4호차 등교(칠곡부영5단지)", "4호차 하교(상인초등학교)", "5호차 등교(대곡강산타운)", 
    "5호차 하교(계명대학교)", "6호차 등교(본리네거리)", "6호차 하교(수성동일하이빌)", 
    "7호차 등교(파동 우방1차)", "7호차 하교(고려자동차학원)", "8호차 등교(봉덕시장)", 
    "8호차 하교(TBC)", "9호차 등교(TBC)", "※신청전용(경주)", "※신청전용(구미)", 
    "※신청전용(울산)", "※신청전용(포항)", "교양관(08:20)-지식산업지구", "구미(등교)", 
    "구미(하교)", "사월역(08:00)", "사월역(08:05)", "사월역(08:10)", "사월역(08:20)", 
    "사월역(09:00)", "사월역(09:30)", "사월역(09:50)", "사월역(10:00)", 
    "성야고보관(16:10)-사월역", "성야고보관(16:40)-사월역", "성야고보관(17:10)-사월역", 
    "성야고보관(17:40)-사월역", "성예로니모관(09:10)-지식산업지구", "성예로니모관(10:05)-지식산업지구", 
    "성예로니모관(10:35)-지식산업지구", "성예로니모관(12:10)-지식산업지구", "성예로니모관(13:00)-지식산업지구", 
    "성예로니모관(14:00)-지식산업지구", "성예로니모관(15:00)-지식산업지구", "성예로니모관(17:00)-지식산업지구", 
    "성예로니모관(17:10)-사월역", "성예로니모관(17:10)-하양역", "성예로니모관(18:00)-지식산업지구", 
    "성예로니모관(20:00)-지식산업지구", "성요한보스코관(14:20)-하양역", "성요한보스코관(14:40)-하양역", 
    "성요한보스코관(15:20)-하양역", "성요한보스코관(15:40)-하양역", "성요한보스코관(16:00)-하양역", 
    "성요한보스코관(16:10)-하양역", "성요한보스코관(16:20)-하양역", "성요한보스코관(16:30)-하양역", 
    "성요한보스코관(16:40)-하양역", "성요한보스코관(17:00)-하양역", "성요한보스코관(17:15)-하양역", 
    "성요한보스코관(17:30)-하양역", "성요한보스코관(18:10)-오피스텔", "야간(21:00)", 
    "울산/경주(등교)", "울산/경주(하교)", "파인앤유더퍼스트오피스텔(08:10)", 
    "파인앤유더퍼스트오피스텔(08:30)", "파인앤유더퍼스트오피스텔(08:40)", "포항(등교)", 
    "포항(하교)", "하양(대구가톨릭대)역건너(08:20)", "하양(대구가톨릭대)역건너(08:25)", 
    "하양(대구가톨릭대)역건너(08:30)", "하양(대구가톨릭대)역건너(08:35)", "하양(대구가톨릭대)역건너(08:40)", 
    "하양(대구가톨릭대)역건너(08:40)", "하양(대구가톨릭대)역건너(08:45)", "하양(대구가톨릭대)역건너(08:50)", 
    "하양(대구가톨릭대)역건너(08:55)", "하양(대구가톨릭대)역건너(09:00)", "하양(대구가톨릭대)역건너(09:20)", 
    "하양(대구가톨릭대)역건너(09:30)", "하양(대구가톨릭대)역건너(09:35)", "하양(대구가톨릭대)역건너(09:40)", 
    "하양(대구가톨릭대)역건너(09:40)", "하양(대구가톨릭대)역건너(09:45)", "하양(대구가톨릭대)역건너(09:50)", 
    "하양(대구가톨릭대)역건너(10:00)", "하양(대구가톨릭대)역건너(10:10)", "하양(대구가톨릭대)역건너(10:20)", 
    "하양(대구가톨릭대)역건너(10:30)", "하양(대구가톨릭대)역건너(10:35)", "하양(대구가톨릭대)역건너(10:40)", 
    "하양(대구가톨릭대)역건너(10:55)", "하양(대구가톨릭대)역건너(11:15)", "하양(대구가톨릭대)역건너(11:30)", 
    "하양(대구가톨릭대)역건너(11:45)"
]

def seed_shuttle_data():
    db = SessionLocal()
    try:
        print("🔄 노선 데이터 동기화를 시작합니다 (Upsert 방식)...")
        
        # 1. 현재 DB에 있는 모든 노선을 이름을 키로 가져옴
        existing_routes = {r.route_name: r for r in db.query(models.BusRoute).all()}
        
        count_added = 0
        count_updated = 0
        
        for item in shuttle_data_raw:
            # 시간 및 장소 추출 로직
            time_match = re.search(r"\((\d{2}:\d{2})\)", item)
            extracted_time = time_match.group(1) if time_match else None
            location_name = re.sub(r"\(\d{2}:\d{2}\)", "", item).strip()
            
            if item in existing_routes:
                # 🌟 [Update] 이미 있는 노선이면 정보만 업데이트 (ID 유지)
                route = existing_routes[item]
                route.location = location_name
                route.time = extracted_time
                route.total_seats = 45
                count_updated += 1
            else:
                # 🌟 [Insert] 없는 노선이면 새로 추가
                new_route = models.BusRoute(
                    route_name=item,
                    location=location_name,
                    time=extracted_time,
                    total_seats=45
                )
                db.add(new_route)
                count_added += 1
        
        db.commit()
        print(f"✅ 동기화 완료: 업데이트 {count_updated}건, 신규 추가 {count_added}건.")
        print("💡 사용자의 즐겨찾기 및 예약 데이터가 안전하게 보존되었습니다.")
        
    except Exception as e:
        print(f"❌ 오류 발생: {e}")
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    seed_shuttle_data()
