import re
from database import SessionLocal, engine
import models

# 데이터베이스 테이블 생성
models.Base.metadata.create_all(bind=engine)

# 사용자가 제공한 전체 데이터 리스트
shuttle_data_raw = [
    "1호차 등교(계명대학교)", "1호차 하교(동천지구대)", "2호차 등교(서구청)", 
    "2호차 하교(홈플러스 칠곡점)", "3호차 등교(동서영남아파트)", "3호차 하교(서부정류장역)", 
    "4호차 등교(칠곡부영5단지)", "4호차 하교(상인초등학교)", "5호차 등교(대곡강산타운)", 
    "5호차 하교(계명대학교)", "6호차 등교(본리네거리)", "6호차 하교(수성동일하이빌)", 
    "7호차 등교(파동 우방1차)", "7호차 하교(고려자동차학원)", "8호차 등교(봉덕시장)", 
    "8호차 하교(TBC)", "9호차 등교(TBC)", "※신청전용(경주)", "※신청전용(구미)", 
    "※신청전용(울산)", "※신청전용(포항)", "교양관(08:20)-지식산업지구", "구미(등교)", 
    "구미(하교)", "사월역(08:00)", "사월역(08:05)", "사월역(08:10)", "사월역(08:20)", 
    "사월역(09:00)", "사월역(09:30)", "사월역(09:50)", "사월역(10:00)", 
    "성야고보관(16:10)-사월역", "성야고보관(16:40)-사월역", "성야고보관(17:10)-사월역", 
    "성야고보관(17:40)-사월역", "성예로니모관(09:10)-지식산업지구", "성예로니모관(10:05)-지식산업지구", 
    "성예로니모관(10:35)-지식산업지구", "성예로니모관(12:10)-지식산업지구", "성예로니모관(13:00)-지식산업지구", 
    "성예로니모관(14:00)-지식산업지구", "성예로니모관(15:00)-지식산업지구", "성예로니모관(17:00)-지식산업지구", 
    "성예로니모관(17:10)-사월역", "성예로니모관(17:10)-하양역", "성예로니모관(18:00)-지식산업지구", 
    "성예로니모관(20:00)-지식산업지구", "성요한보스코관(14:20)-하양역", "성요한보스코관(14:40)-하양역", 
    "성요한보스코관(15:20)-하양역", "성요한보스코관(15:40)-하양역", "성요한보스코관(16:00)-하양역", 
    "성요한보스코관(16:10)-하양역", "성요한보스코관(16:20)-하양역", "성요한보스코관(16:30)-하양역", 
    "성요한보스코관(16:40)-하양역", "성요한보스코관(17:00)-하양역", "성요한보스코관(17:15)-하양역", 
    "성요한보스코관(17:30)-하양역", "성요한보스코관(18:10)-오피스텔", "야간(21:00)", 
    "울산/경주(등교)", "울산/경주(하교)", "파인앤유더퍼스트오피스텔(08:10)", 
    "파인앤유더퍼스트오피스텔(08:30)", "파인앤유더퍼스트오피스텔(08:40)", "포항(등교)", 
    "포항(하교)", "하양(대구가톨릭대)역건너(08:20)", "하양(대구가톨릭대)역건너(08:25)", 
    "하양(대구가톨릭대)역건너(08:30)", "하양(대구가톨릭대)역건너(08:35)", "하양(대구가톨릭대)역건너(08:40)", 
    "하양(대구가톨릭대)역건너(08:40)", "하양(대구가톨릭대)역건너(08:45)", "하양(대구가톨릭대)역건너(08:50)", 
    "하양(대구가톨릭대)역건너(08:55)", "하양(대구가톨릭대)역건너(09:00)", "하양(대구가톨릭대)역건너(09:20)", 
    "하양(대구가톨릭대)역건너(09:30)", "하양(대구가톨릭대)역건너(09:35)", "하양(대구가톨릭대)역건너(09:40)", 
    "하양(대구가톨릭대)역건너(09:40)", "하양(대구가톨릭대)역건너(09:45)", "하양(대구가톨릭대)역건너(09:50)", 
    "하양(대구가톨릭대)역건너(10:00)", "하양(대구가톨릭대)역건너(10:10)", "하양(대구가톨릭대)역건너(10:20)", 
    "하양(대구가톨릭대)역건너(10:30)", "하양(대구가톨릭대)역건너(10:35)", "하양(대구가톨릭대)역건너(10:40)", 
    "하양(대구가톨릭대)역건너(10:55)", "하양(대구가톨릭대)역건너(11:15)", "하양(대구가톨릭대)역건너(11:30)", 
    "하양(대구가톨릭대)역건너(11:45)"
]

def seed_shuttle_data():
    db = SessionLocal()
    try:
        # 기존 데이터 초기화 (중복 방지)
        db.query(models.BusRoute).delete()
        
        for item in shuttle_data_raw:
            # 1. 시간 추출: (00:00) 형태 찾기
            time_match = re.search(r"\((\d{2}:\d{2})\)", item)
            extracted_time = time_match.group(1) if time_match else None
            
            # 2. 장소명 추출: 괄호 부분 및 특수기호 제거
            # 예: "하양(대구가톨릭대)역건너(08:20)" -> "하양(대구가톨릭대)역건너"
            location_name = re.sub(r"\(\d{2}:\d{2}\)", "", item).strip()
            
            # 3. 데이터 객체 생성
            route = models.BusRoute(
                route_name=item,        # 원본 전체 이름
                location=location_name,  # 가공된 장소명
                time=extracted_time,    # 추출된 시간 (없으면 None)
                total_seats=45          # 기본 좌석 수
            )
            db.add(route)
        
        db.commit()
        print(f"✅ 성공: 총 {len(shuttle_data_raw)}개의 셔틀 노선 데이터가 DB(shuttle.db)에 저장되었습니다.")
        
    except Exception as e:
        print(f"❌ 오류 발생: {e}")
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    seed_shuttle_data()